{% extends 'base.html' %}
{% block container %}
  <div class="row" style="text-align:center">
    <div class="col-lg-12 col-md-12" >
        <br/>
        <select id="report-select">
            <option value=""> -- Select Report -- </option>
            {% for report in reports %}
            {% if report.id == run_id %}
            <option value='{{report.id}}' selected>{{report.report_file}} - {{report.report_name}}</option>
            {% else %}
            <option value='{{report.id}}'>{{report.report_file}} - {{report.report_name}}</option>
            {% endif %}
            {% endfor %}
          </select>
    </div>
    <div class="col-lg-12 col-md-12 ">
      {% if report.report_name %}
       <h4>{{report.report_name}}  ({{report.details}}) </h4>
      {% endif %}
      </div>
  </div>

  {% if report %}
  {{json_file}}
  <div class="generated-on">
    {{generated_on}}
  </div>
  <div class="row">
    <div class="chart col-lg-6 col-md-6" id="piechart_features"></div>
    <div class="chart col-lg-6 col-md-6" id="piechart_scenarios"></div>
  </div>
  <!-- Metadata starts -->
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" href="#logOutput">
          <i class="glyphicon glyphicon-chevron-right"></i>
          <i class="glyphicon glyphicon-chevron-down"></i>
          <b>Metadata</b>
        </a>
      </h4>
    </div>
    <div id="logOutput" class="panel-collapse collapse">
      <div class="panel-body">
        <div class="row">
          <div class="clearfix metadata col-xs-12 col-sm-6 col-md-6 col-lg-6">
            <div class=left>
              <strong> Project: </strong>{{environment.project}}
            </div>
          </div>
          <div class="clearfix metadata col-xs-12 col-sm-6 col-md-6 col-lg-6">
            <div class=pull-right-lg>
              <strong> Test Environment: </strong> {{environment.environment}}
            </div>
          </div>
          <div class="clearfix metadata col-xs-12 col-sm-6 col-md-6 col-lg-6">
            <div class=left>
              <strong> Browser Driver:</strong> {{environment.driver}}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Metadata ends -->
  {% for feature in report_json  %}
  <!-- Left Start -->
  <div class="col-lg-6 col-md-6">
    <div class="panel panel-default">
      {% include 'features-header.html' %}
      {% include 'features-collapsable-parallel-header.html' %}
    </div>
  </div>
  <!-- Left Panel -->
  {% endfor %}


  {% else %}
  <div class="col-lg-6 col-md-6">
      <i><strong> Select Report </strong></i> 
  </div>

  {% endif %}

  <div class="navbar-fixed-bottom row-fluid footer-div ">
    <div class="navbar-inner">
      <div class="footer-container">
        <a target="_blank" href="https://www.npmjs.com/package/cucumber-html-reporter">
          <div class="text-muted footer-link">
            generated by @cucumber-html-reporter
          </div>
        </a>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.5.1/moment.min.js"></script>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script type="text/javascript">
    google.load("visualization", "1", { packages: ["corechart"] });
    google.setOnLoadCallback(function () {
      drawChart({
        "title": "Features",
        "failed": {{ failed_features }},
      "passed": {{ passed_features }}
    })
  });
    google.setOnLoadCallback(function () {
      drawChart({
        "title": "Scenarios",
        "failed": {{ failed_scenarios }},
      "passed": {{ passed_scenarios }},
      "notdefined": {{ notdefined_scenarios }},
      "skipped": {{ skipped_secenarios }}
    })
  });
  </script>
  <script>




    $(document).ready(function () {

      $('.collapse').on('hide.bs.collapse', function (e) {
        e.stopPropagation();
        $(this).prev().removeClass('open');
      }).on('show.bs.collapse', function (e) {
        e.stopPropagation();
        $(this).prev().addClass('open');
      });

      $('a.toggle').on('click', function () {
        if ($(this).text() === 'Screenshot -') {
          $(this).text('Screenshot +');
          $(this).siblings('a.screenshot').find('img').hide();
        } else {
          $(this).text('Screenshot -');
          $(this).siblings('a.screenshot').find('img').show();
        }
      });

      var $generated = $('.generated-on');
      $generated.text('Generated ' + moment($generated.text()).fromNow());

      // bind change event to select
      $('#report-select').on('change', function () {
        var url = $(this).val(); // get selected value
        window.location = "/runs/" + url; // redirect

        return false;
      });

    });

    function drawChart(chartData) {
      var data = google.visualization.arrayToDataTable([
        ['Task', 'Cucumber Results'],
        ['Passed', chartData.passed],
        ['Failed', chartData.failed],
        ['Pending', chartData.notdefined],
        ['Skipped', chartData.skipped]
      ]);

      var total = chartData.passed + chartData.failed + (chartData.notdefined || 0) + (chartData.skipped || 0);
      var title;

      if (total === 1) {
        title = total + ' ' + chartData.title.slice(0, -1)
      } else {
        title = total + ' ' + chartData.title;
      }

      var options = {
        width: '100%',
        height: 240,
        title: title,
        is3D: true,
        colors: ['#5cb85c', '#d9534f', '#5bc0de', '#f0ad4e'],
        fontSize: '13',
        fontName: '"Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif',
        slices: {
          1: { offset: 0.4 },
          2: { offset: 0.4 },
          3: { offset: 0.4 }
        },
        titleTextStyle: {
          fontSize: '13',
          color: '#5e5e5e'
        }
      };

      var chart = new google.visualization.PieChart(document.getElementById('piechart_' + chartData.title.toLowerCase()));
      chart.draw(data, options);
    }
  </script>
  {% endblock %}